// ============================================
// Clean Shop — Prisma Database Schema
// Інтернет-магазин побутової хімії
// Відповідає ТЗ розділ 23
// ============================================

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─────────────────────────────────────
// 23.1 Users (Користувачі)
// ─────────────────────────────────────
enum UserRole {
  client
  wholesaler
  manager
  admin
}

enum WholesaleStatus {
  none
  pending
  approved
  rejected
}

enum OwnershipType {
  fop
  tov
  pp
  other
}

enum TaxSystem {
  with_vat
  without_vat
}

model User {
  id                    Int              @id @default(autoincrement())
  email                 String           @unique
  passwordHash          String?          @map("password_hash")
  fullName              String           @map("full_name")
  phone                 String?
  role                  UserRole         @default(client)
  companyName           String?          @map("company_name")
  edrpou                String?
  legalAddress          String?          @map("legal_address")
  bankIban              String?          @map("bank_iban")
  bankName              String?          @map("bank_name")
  bankMfo               String?          @map("bank_mfo")
  ownershipType         OwnershipType?   @map("ownership_type")
  taxSystem             TaxSystem?       @map("tax_system")
  contactPersonName     String?          @map("contact_person_name")
  contactPersonPhone    String?          @map("contact_person_phone")
  wholesaleStatus       WholesaleStatus  @default(none) @map("wholesale_status")
  wholesaleRequestDate  DateTime?        @map("wholesale_request_date")
  wholesaleApprovedDate DateTime?        @map("wholesale_approved_date")
  wholesaleMonthlyVol   String?          @map("wholesale_monthly_volume")
  assignedManagerId     Int?             @map("assigned_manager_id")
  assignedManager       User?            @relation("ManagerToClient", fields: [assignedManagerId], references: [id])
  managedClients        User[]           @relation("ManagerToClient")
  referralCode          String?          @unique @map("referral_code")
  notificationPrefs     Json?            @map("notification_preferences")
  googleId              String?          @unique @map("google_id")
  telegramChatId        BigInt?          @map("telegram_chat_id")
  viberUserId           String?          @map("viber_user_id")
  avatarUrl             String?          @map("avatar_url")
  isVerified            Boolean          @default(false) @map("is_verified")
  createdAt             DateTime         @default(now()) @map("created_at")
  updatedAt             DateTime         @updatedAt @map("updated_at")

  orders              Order[]
  cartItems           CartItem[]
  wishlists           Wishlist[]
  notifications       UserNotification[]
  addresses           UserAddress[]
  refreshTokens       RefreshToken[]
  recentlyViewed      RecentlyViewed[]
  searchHistory       SearchHistory[]
  productNotes        ProductNote[]
  auditLogs           AuditLog[]
  importLogs          ImportLog[]
  personalPricesUser  PersonalPrice[]    @relation("PersonalPriceUser")
  personalPricesAdmin PersonalPrice[]    @relation("PersonalPriceCreator")
  referralsMade       Referral[]         @relation("Referrer")
  referralsReceived   Referral[]         @relation("Referred")
  clientEvents        ClientEvent[]
  publications        Publication[]
  feedbackProcessed   Feedback[]         @relation("FeedbackProcessor")
  paymentsConfirmed   Payment[]          @relation("PaymentConfirmer")
  deliveriesCreated   Delivery[]
  dashboardSettings     DashboardSettings?
  reportTemplates       ReportTemplate[]
  analyticsAlerts       AnalyticsAlert[]
  loyaltyAccount        LoyaltyAccount?
  loyaltyTransactions   LoyaltyTransaction[]
  pushSubscriptions     PushSubscription[]

  @@map("users")
}

// ─────────────────────────────────────
// 23.30 Categories (Категорії)
// ─────────────────────────────────────
model Category {
  id             Int        @id @default(autoincrement())
  name           String
  slug           String     @unique
  iconPath       String?    @map("icon_path")
  coverImage     String?    @map("cover_image")
  description    String?
  seoTitle       String?    @map("seo_title")
  seoDescription String?    @map("seo_description")
  sortOrder      Int        @default(0) @map("sort_order")
  isVisible      Boolean    @default(true) @map("is_visible")
  parentId       Int?       @map("parent_id")
  parent         Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children       Category[] @relation("CategoryTree")
  mergedFrom     Json?      @map("merged_from")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")

  products     Product[]
  publications Publication[] @relation("PublicationCategory")

  @@map("categories")
}

// ─────────────────────────────────────
// 23.2 Products (Товари)
// ─────────────────────────────────────
model Product {
  id                Int       @id @default(autoincrement())
  code              String    @unique
  name              String    @db.VarChar(255)
  slug              String    @unique @db.VarChar(255)
  categoryId        Int?      @map("category_id")
  category          Category? @relation(fields: [categoryId], references: [id])
  priceRetail       Decimal   @map("price_retail") @db.Decimal(10, 2)
  priceWholesale    Decimal?  @map("price_wholesale") @db.Decimal(10, 2)
  priceRetailOld    Decimal?  @map("price_retail_old") @db.Decimal(10, 2)
  priceWholesaleOld Decimal?  @map("price_wholesale_old") @db.Decimal(10, 2)
  quantity          Int       @default(0)
  isPromo           Boolean   @default(false) @map("is_promo")
  promoStartDate    DateTime? @map("promo_start_date")
  promoEndDate      DateTime? @map("promo_end_date")
  isActive          Boolean   @default(true) @map("is_active")
  imagePath         String?   @map("image_path")
  sortOrder         Int       @default(0) @map("sort_order")
  viewsCount        Int       @default(0) @map("views_count")
  ordersCount       Int       @default(0) @map("orders_count")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")
  searchVector      Unsupported("tsvector")?  @map("search_vector")

  content         ProductContent?
  images          ProductImage[]
  badges          ProductBadge[]
  orderItems      OrderItem[]
  cartItems       CartItem[]
  wishlistItems   WishlistItem[]
  recentlyViewed  RecentlyViewed[]
  priceHistory    PriceHistory[]
  productNotes    ProductNote[]
  searchClicks    SearchHistory[]
  recommendations ProductRecommendation[] @relation("RecommendedFrom")
  recommendedBy   ProductRecommendation[] @relation("RecommendedTo")
  personalPrices  PersonalPrice[]
  publications    Publication[]           @relation("PublicationProduct")
  wholesaleRules  WholesaleRule[]
  clientEvents    ClientEvent[]

  @@index([categoryId])
  @@index([isActive, isPromo])
  @@index([priceRetail])
  @@index([createdAt(sort: Desc)])
  @@map("products")
}

// ─────────────────────────────────────
// 23.3 Product_Content (Контент товарів)
// ─────────────────────────────────────
model ProductContent {
  id                Int      @id @default(autoincrement())
  productId         Int      @unique @map("product_id")
  product           Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  shortDescription  String?  @map("short_description") @db.VarChar(200)
  fullDescription   String?  @map("full_description")
  specifications    String?
  usageInstructions String?  @map("usage_instructions")
  videoUrl          String?  @map("video_url")
  seoTitle          String?  @map("seo_title")
  seoDescription    String?  @map("seo_description")
  isFilled          Boolean  @default(false) @map("is_filled")
  filledBy          Int?     @map("filled_by")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("product_content")
}

// ─────────────────────────────────────
// 23.46 Product_Images
// ─────────────────────────────────────
model ProductImage {
  id               Int      @id @default(autoincrement())
  productId        Int      @map("product_id")
  product          Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  originalFilename String?  @map("original_filename")
  pathOriginal     String?  @map("path_original")
  pathFull         String?  @map("path_full")
  pathMedium       String?  @map("path_medium")
  pathThumbnail    String?  @map("path_thumbnail")
  pathBlur         String?  @map("path_blur")
  format           String?
  sizeBytes        Int?     @map("size_bytes")
  width            Int?
  height           Int?
  sortOrder        Int      @default(0) @map("sort_order")
  altText          String?  @map("alt_text")
  isMain           Boolean  @default(false) @map("is_main")
  createdAt        DateTime @default(now()) @map("created_at")

  @@index([productId, sortOrder])
  @@map("product_images")
}

// ─────────────────────────────────────
// 23.16 Product_Badges
// ─────────────────────────────────────
enum BadgeType {
  promo
  new_arrival
  hit
  eco
  custom
}

model ProductBadge {
  id          Int       @id @default(autoincrement())
  productId   Int       @map("product_id")
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  badgeType   BadgeType @map("badge_type")
  customText  String?   @map("custom_text")
  customColor String?   @map("custom_color")
  priority    Int       @default(0)
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")

  @@map("product_badges")
}

// ─────────────────────────────────────
// 23.17 Product_Recommendations
// ─────────────────────────────────────
enum RecommendationType {
  bought_together
  similar
  manual
}

model ProductRecommendation {
  id                   Int                @id @default(autoincrement())
  productId            Int                @map("product_id")
  product              Product            @relation("RecommendedFrom", fields: [productId], references: [id], onDelete: Cascade)
  recommendedProductId Int                @map("recommended_product_id")
  recommendedProduct   Product            @relation("RecommendedTo", fields: [recommendedProductId], references: [id], onDelete: Cascade)
  recommendationType   RecommendationType @map("recommendation_type")
  score                Float              @default(0)
  createdAt            DateTime           @default(now()) @map("created_at")
  updatedAt            DateTime           @updatedAt @map("updated_at")

  @@map("product_recommendations")
}

// ─────────────────────────────────────
// 23.15 Price_History
// ─────────────────────────────────────
model PriceHistory {
  id                Int      @id @default(autoincrement())
  productId         Int      @map("product_id")
  product           Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  priceRetailOld    Decimal? @map("price_retail_old") @db.Decimal(10, 2)
  priceRetailNew    Decimal? @map("price_retail_new") @db.Decimal(10, 2)
  priceWholesaleOld Decimal? @map("price_wholesale_old") @db.Decimal(10, 2)
  priceWholesaleNew Decimal? @map("price_wholesale_new") @db.Decimal(10, 2)
  changedAt         DateTime @default(now()) @map("changed_at")
  importId          Int?     @map("import_id")

  @@map("price_history")
}

// ─────────────────────────────────────
// 23.4 Orders (Замовлення)
// ─────────────────────────────────────
enum OrderStatus {
  new_order @map("new")
  processing
  confirmed
  paid
  shipped
  completed
  cancelled
  returned
}

enum ClientType {
  retail
  wholesale
}

enum DeliveryMethod {
  nova_poshta
  ukrposhta
  pickup
  pallet
}

enum PaymentMethod {
  cod
  bank_transfer
  online
  card_prepay
}

enum PaymentStatus {
  pending
  paid
  partial
  refunded
}

enum OrderSource {
  web
  telegram_bot
  viber_bot
}

model Order {
  id                   Int            @id @default(autoincrement())
  userId               Int?           @map("user_id")
  user                 User?          @relation(fields: [userId], references: [id])
  orderNumber          String         @unique @map("order_number")
  status               OrderStatus    @default(new_order)
  clientType           ClientType     @map("client_type")
  totalAmount          Decimal        @map("total_amount") @db.Decimal(10, 2)
  discountAmount       Decimal        @default(0) @map("discount_amount") @db.Decimal(10, 2)
  deliveryCost         Decimal        @default(0) @map("delivery_cost") @db.Decimal(10, 2)
  itemsCount           Int            @map("items_count")
  contactName          String         @map("contact_name")
  contactPhone         String         @map("contact_phone")
  contactEmail         String         @map("contact_email")
  deliveryMethod       DeliveryMethod @map("delivery_method")
  deliveryCity         String?        @map("delivery_city")
  deliveryWarehouseRef String?        @map("delivery_warehouse_ref")
  deliveryAddress      String?        @map("delivery_address")
  trackingNumber       String?        @map("tracking_number")
  paymentMethod        PaymentMethod  @map("payment_method")
  paymentStatus        PaymentStatus  @default(pending) @map("payment_status")
  comment              String?
  managerComment       String?        @map("manager_comment")
  cancelledReason      String?        @map("cancelled_reason")
  cancelledBy          String?        @map("cancelled_by")
  source               OrderSource    @default(web)
  utmSource            String?        @map("utm_source")
  utmMedium            String?        @map("utm_medium")
  utmCampaign          String?        @map("utm_campaign")
  ipAddress            String?        @map("ip_address")
  userAgent            String?        @map("user_agent")
  createdAt            DateTime       @default(now()) @map("created_at")
  updatedAt            DateTime       @updatedAt @map("updated_at")

  items         OrderItem[]
  statusHistory OrderStatusHistory[]
  payment       Payment?
  delivery      Delivery?

  @@index([userId, createdAt(sort: Desc)])
  @@index([status])
  @@index([status, createdAt])
  @@index([paymentStatus])
  @@map("orders")
}

// ─────────────────────────────────────
// 23.5 Order_Items
// ─────────────────────────────────────
model OrderItem {
  id           Int      @id @default(autoincrement())
  orderId      Int      @map("order_id")
  order        Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId    Int?     @map("product_id")
  product      Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  productCode  String   @map("product_code")
  productName  String   @map("product_name")
  priceAtOrder Decimal  @map("price_at_order") @db.Decimal(10, 2)
  quantity     Int
  subtotal     Decimal  @db.Decimal(10, 2)
  isPromo      Boolean  @default(false) @map("is_promo")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// ─────────────────────────────────────
// 23.51 Order_Status_History
// ─────────────────────────────────────
enum ChangeSource {
  manager
  client_action @map("client")
  system
  cron
}

model OrderStatusHistory {
  id           Int          @id @default(autoincrement())
  orderId      Int          @map("order_id")
  order        Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  oldStatus    String?      @map("old_status")
  newStatus    String       @map("new_status")
  changedBy    Int?         @map("changed_by")
  changeSource ChangeSource @map("change_source")
  comment      String?
  ipAddress    String?      @map("ip_address")
  createdAt    DateTime     @default(now()) @map("created_at")

  @@index([orderId, createdAt])
  @@index([newStatus])
  @@map("order_status_history")
}

// ─────────────────────────────────────
// 23.38 Payments
// ─────────────────────────────────────
model Payment {
  id              Int           @id @default(autoincrement())
  orderId         Int           @unique @map("order_id")
  order           Order         @relation(fields: [orderId], references: [id])
  paymentMethod   PaymentMethod @map("payment_method")
  paymentStatus   PaymentStatus @map("payment_status") @default(pending)
  amount          Decimal       @db.Decimal(10, 2)
  paidAt          DateTime?     @map("paid_at")
  confirmedBy     Int?          @map("confirmed_by")
  confirmer       User?         @relation("PaymentConfirmer", fields: [confirmedBy], references: [id])
  transactionId   String?       @map("transaction_id")
  invoicePdfUrl   String?       @map("invoice_pdf_url")
  notes           String?
  paymentProvider String?       @map("payment_provider") // 'liqpay' | 'monobank'
  callbackData    Json?         @map("callback_data")
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  @@map("payments")
}

// ─────────────────────────────────────
// 23.39 Deliveries
// ─────────────────────────────────────
enum DeliveryStatus {
  pending_delivery  @map("pending")
  shipped_delivery  @map("shipped")
  in_transit
  delivered
  returned_delivery @map("returned")
}

model Delivery {
  id                    Int            @id @default(autoincrement())
  orderId               Int            @unique @map("order_id")
  order                 Order          @relation(fields: [orderId], references: [id])
  deliveryMethod        DeliveryMethod @map("delivery_method")
  deliveryStatus        DeliveryStatus @default(pending_delivery) @map("delivery_status")
  city                  String?
  warehouseRef          String?        @map("warehouse_ref")
  addressText           String?        @map("address_text")
  trackingNumber        String?        @map("tracking_number")
  trackingUrl           String?        @map("tracking_url")
  estimatedDeliveryDate DateTime?      @map("estimated_delivery_date")
  actualDeliveryDate    DateTime?      @map("actual_delivery_date")
  deliveryCost          Decimal        @default(0) @map("delivery_cost") @db.Decimal(10, 2)
  weightKg              Decimal?       @map("weight_kg") @db.Decimal(6, 2)
  createdBy             Int?           @map("created_by")
  creator               User?          @relation(fields: [createdBy], references: [id])
  createdAt             DateTime       @default(now()) @map("created_at")
  updatedAt             DateTime       @updatedAt @map("updated_at")

  @@map("deliveries")
}

// ─────────────────────────────────────
// 23.42 Cart_Items
// ─────────────────────────────────────
model CartItem {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId Int      @map("product_id")
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity  Int
  addedAt   DateTime @default(now()) @map("added_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, productId])
  @@map("cart_items")
}

// ─────────────────────────────────────
// 23.8-9 Wishlists
// ─────────────────────────────────────
model Wishlist {
  id        Int            @id @default(autoincrement())
  userId    Int            @map("user_id")
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  createdAt DateTime       @default(now()) @map("created_at")
  updatedAt DateTime       @updatedAt @map("updated_at")
  items     WishlistItem[]

  @@map("wishlists")
}

model WishlistItem {
  id         Int      @id @default(autoincrement())
  wishlistId Int      @map("wishlist_id")
  wishlist   Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)
  productId  Int      @map("product_id")
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  addedAt    DateTime @default(now()) @map("added_at")

  @@unique([wishlistId, productId])
  @@map("wishlist_items")
}

// ─────────────────────────────────────
// 23.37 Product_Notes
// ─────────────────────────────────────
model ProductNote {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId Int      @map("product_id")
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  noteText  String   @map("note_text") @db.VarChar(500)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, productId])
  @@map("product_notes")
}

// ─────────────────────────────────────
// 23.33 User_Notifications
// ─────────────────────────────────────
enum NotificationType {
  order_status
  price_change
  back_in_stock
  promo
  system_notification @map("system")
}

model UserNotification {
  id               Int              @id @default(autoincrement())
  userId           Int              @map("user_id")
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  notificationType NotificationType @map("notification_type")
  title            String
  message          String
  link             String?
  isRead           Boolean          @default(false) @map("is_read")
  createdAt        DateTime         @default(now()) @map("created_at")
  readAt           DateTime?        @map("read_at")

  @@map("user_notifications")
}

// ─────────────────────────────────────
// 23.34 User_Addresses
// ─────────────────────────────────────
model UserAddress {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  label      String?
  city       String
  street     String?
  building   String?
  apartment  String?
  postalCode String?  @map("postal_code")
  isDefault  Boolean  @default(false) @map("is_default")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("user_addresses")
}

// ─────────────────────────────────────
// 23.49 Refresh_Tokens
// ─────────────────────────────────────
model RefreshToken {
  id         Int       @id @default(autoincrement())
  userId     Int       @map("user_id")
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tokenHash  String    @unique @map("token_hash")
  deviceInfo String?   @map("device_info") @db.VarChar(500)
  ipAddress  String?   @map("ip_address")
  expiresAt  DateTime  @map("expires_at")
  revokedAt  DateTime? @map("revoked_at")
  createdAt  DateTime  @default(now()) @map("created_at")

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// ─────────────────────────────────────
// 23.40 Recently_Viewed
// ─────────────────────────────────────
model RecentlyViewed {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId Int      @map("product_id")
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  viewedAt  DateTime @default(now()) @map("viewed_at")

  @@unique([userId, productId])
  @@index([userId, viewedAt])
  @@map("recently_viewed")
}

// ─────────────────────────────────────
// 23.47 Search_History
// ─────────────────────────────────────
model SearchHistory {
  id               Int      @id @default(autoincrement())
  userId           Int?     @map("user_id")
  user             User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  query            String   @db.VarChar(255)
  resultsCount     Int      @default(0) @map("results_count")
  clickedProductId Int?     @map("clicked_product_id")
  clickedProduct   Product? @relation(fields: [clickedProductId], references: [id], onDelete: SetNull)
  createdAt        DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt(sort: Desc)])
  @@map("search_history")
}

// ─────────────────────────────────────
// 23.6 Publications
// ─────────────────────────────────────
enum PublicationStatus {
  draft
  scheduled
  published
  failed
}

model Publication {
  id             Int               @id @default(autoincrement())
  title          String
  content        String
  imagePath      String?           @map("image_path")
  productId      Int?              @map("product_id")
  product        Product?          @relation("PublicationProduct", fields: [productId], references: [id])
  categoryId     Int?              @map("category_id")
  category       Category?         @relation("PublicationCategory", fields: [categoryId], references: [id])
  channels       Json
  status         PublicationStatus @default(draft)
  scheduledAt    DateTime?         @map("scheduled_at")
  publishedAt    DateTime?         @map("published_at")
  createdBy      Int               @map("created_by")
  creator        User              @relation(fields: [createdBy], references: [id])
  hashtags       String?
  firstComment   String?           @map("first_comment")
  igMediaId      String?           @map("ig_media_id")
  igPermalink    String?           @map("ig_permalink")
  igInsightsJson Json?             @map("ig_insights_json")
  tgMessageId    BigInt?           @map("tg_message_id")
  viberMsgToken  String?           @map("viber_message_token")
  buttons        Json?
  templateType   String?           @map("template_type")
  errorMessage   String?           @map("error_message")
  retryCount     Int               @default(0) @map("retry_count")
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")

  images PublicationImage[]

  @@index([status, scheduledAt])
  @@index([createdBy])
  @@index([publishedAt(sort: Desc)])
  @@map("publications")
}

model PublicationImage {
  id            Int         @id @default(autoincrement())
  publicationId Int         @map("publication_id")
  publication   Publication @relation(fields: [publicationId], references: [id], onDelete: Cascade)
  imagePath     String      @map("image_path")
  imageUrl      String?     @map("image_url")
  sortOrder     Int         @default(0) @map("sort_order")
  altText       String?     @map("alt_text")
  igMediaId     String?     @map("ig_media_id")
  width         Int?
  height        Int?
  sizeBytes     Int?        @map("size_bytes")
  createdAt     DateTime    @default(now()) @map("created_at")

  @@index([publicationId, sortOrder])
  @@map("publication_images")
}

// ─────────────────────────────────────
// 23.7 Themes
// ─────────────────────────────────────
model Theme {
  id               Int       @id @default(autoincrement())
  folderName       String    @unique @map("folder_name")
  displayName      String    @map("display_name")
  description      String?
  version          String?
  author           String?
  previewImagePath String?   @map("preview_image_path")
  isActive         Boolean   @default(false) @map("is_active")
  customSettings   Json?     @map("custom_settings")
  installedAt      DateTime  @default(now()) @map("installed_at")
  activatedAt      DateTime? @map("activated_at")

  @@map("themes")
}

// ─────────────────────────────────────
// 23.10 Feedback
// ─────────────────────────────────────
enum FeedbackType {
  form
  callback
}

enum FeedbackStatus {
  new_feedback @map("new")
  processed
  rejected
}

model Feedback {
  id          Int            @id @default(autoincrement())
  name        String
  email       String?
  phone       String?
  subject     String?
  message     String
  type        FeedbackType   @default(form)
  status      FeedbackStatus @default(new_feedback)
  processedBy Int?           @map("processed_by")
  processor   User?          @relation("FeedbackProcessor", fields: [processedBy], references: [id])
  processedAt DateTime?      @map("processed_at")
  createdAt   DateTime       @default(now()) @map("created_at")

  @@map("feedback")
}

// ─────────────────────────────────────
// 23.11 Static_Pages
// ─────────────────────────────────────
model StaticPage {
  id             Int      @id @default(autoincrement())
  slug           String   @unique
  title          String
  content        String
  seoTitle       String?  @map("seo_title")
  seoDescription String?  @map("seo_description")
  isPublished    Boolean  @default(true) @map("is_published")
  sortOrder      Int      @default(0) @map("sort_order")
  updatedBy      Int?     @map("updated_by")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  @@map("static_pages")
}

// ─────────────────────────────────────
// 23.12 FAQ_Items
// ─────────────────────────────────────
model FaqItem {
  id          Int      @id @default(autoincrement())
  category    String
  question    String
  answer      String
  sortOrder   Int      @default(0) @map("sort_order")
  isPublished Boolean  @default(true) @map("is_published")
  clickCount  Int      @default(0) @map("click_count")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([category, sortOrder])
  @@index([isPublished])
  @@map("faq_items")
}

// ─────────────────────────────────────
// 23.13 Wholesale_Rules
// ─────────────────────────────────────
enum WholesaleRuleType {
  min_order_amount
  min_quantity
  multiplicity
}

model WholesaleRule {
  id        Int               @id @default(autoincrement())
  ruleType  WholesaleRuleType @map("rule_type")
  productId Int?              @map("product_id")
  product   Product?          @relation(fields: [productId], references: [id], onDelete: Cascade)
  value     Decimal           @db.Decimal(10, 2)
  isActive  Boolean           @default(true) @map("is_active")
  createdAt DateTime          @default(now()) @map("created_at")
  updatedAt DateTime          @updatedAt @map("updated_at")

  @@map("wholesale_rules")
}

// ─────────────────────────────────────
// 23.14 Cookie_Consents
// ─────────────────────────────────────
model CookieConsent {
  id                Int      @id @default(autoincrement())
  userId            Int?     @map("user_id")
  sessionId         String   @map("session_id")
  analyticsAccepted Boolean  @default(false) @map("analytics_accepted")
  marketingAccepted Boolean  @default(false) @map("marketing_accepted")
  consentDate       DateTime @default(now()) @map("consent_date")
  ipAddress         String?  @map("ip_address")

  @@map("cookie_consents")
}

// ─────────────────────────────────────
// 23.18 Audit_Log
// ─────────────────────────────────────
enum AuditActionType {
  login
  logout
  role_change
  import_action @map("import")
  order_status_change
  publication_create
  theme_change
  page_edit
  rule_change
  data_delete
}

model AuditLog {
  id         Int             @id @default(autoincrement())
  userId     Int?            @map("user_id")
  user       User?           @relation(fields: [userId], references: [id])
  actionType AuditActionType @map("action_type")
  entityType String          @map("entity_type")
  entityId   Int?            @map("entity_id")
  details    Json?
  ipAddress  String?         @map("ip_address")
  createdAt  DateTime        @default(now()) @map("created_at")

  @@index([actionType])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_log")
}

// ─────────────────────────────────────
// 23.28 Site_Settings
// ─────────────────────────────────────
model SiteSetting {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  updatedBy Int?     @map("updated_by")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("site_settings")
}

// ─────────────────────────────────────
// 23.29 Banners
// ─────────────────────────────────────
model Banner {
  id           Int      @id @default(autoincrement())
  title        String?
  subtitle     String?
  imageDesktop String   @map("image_desktop")
  imageMobile  String?  @map("image_mobile")
  buttonText   String?  @map("button_text")
  buttonLink   String?  @map("button_link")
  sortOrder    Int      @default(0) @map("sort_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdBy    Int?     @map("created_by")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("banners")
}

// ─────────────────────────────────────
// 23.31-32 Email_Templates
// ─────────────────────────────────────
model EmailTemplate {
  id          Int                    @id @default(autoincrement())
  templateKey String                 @unique @map("template_key")
  subject     String
  bodyHtml    String                 @map("body_html")
  bodyText    String?                @map("body_text")
  version     Int                    @default(1)
  isActive    Boolean                @default(true) @map("is_active")
  isMarketing Boolean                @default(false) @map("is_marketing")
  updatedBy   Int?                   @map("updated_by")
  createdAt   DateTime               @default(now()) @map("created_at")
  updatedAt   DateTime               @updatedAt @map("updated_at")
  versions    EmailTemplateVersion[]

  @@map("email_templates")
}

model EmailTemplateVersion {
  id         Int           @id @default(autoincrement())
  templateId Int           @map("template_id")
  template   EmailTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  version    Int
  subject    String
  bodyHtml   String        @map("body_html")
  createdBy  Int?          @map("created_by")
  createdAt  DateTime      @default(now()) @map("created_at")

  @@map("email_template_versions")
}

// ─────────────────────────────────────
// 23.35 Personal_Prices
// ─────────────────────────────────────
model PersonalPrice {
  id              Int       @id @default(autoincrement())
  userId          Int       @map("user_id")
  user            User      @relation("PersonalPriceUser", fields: [userId], references: [id], onDelete: Cascade)
  productId       Int?      @map("product_id")
  product         Product?  @relation(fields: [productId], references: [id], onDelete: Cascade)
  categoryId      Int?      @map("category_id")
  discountPercent Decimal?  @map("discount_percent") @db.Decimal(5, 2)
  fixedPrice      Decimal?  @map("fixed_price") @db.Decimal(10, 2)
  validFrom       DateTime? @map("valid_from")
  validUntil      DateTime? @map("valid_until")
  createdBy       Int       @map("created_by")
  creator         User      @relation("PersonalPriceCreator", fields: [createdBy], references: [id])
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@map("personal_prices")
}

// ─────────────────────────────────────
// 23.36 Referrals
// ─────────────────────────────────────
enum ReferralStatus {
  registered
  first_order
  bonus_granted
}

model Referral {
  id             Int            @id @default(autoincrement())
  referrerUserId Int            @map("referrer_user_id")
  referrer       User           @relation("Referrer", fields: [referrerUserId], references: [id])
  referredUserId Int            @map("referred_user_id")
  referred       User           @relation("Referred", fields: [referredUserId], references: [id])
  referralCode   String         @map("referral_code")
  status         ReferralStatus @default(registered)
  bonusType      String?        @map("bonus_type")
  bonusValue     Decimal?       @map("bonus_value") @db.Decimal(10, 2)
  bonusOrderId   Int?           @map("bonus_order_id")
  createdAt      DateTime       @default(now()) @map("created_at")
  convertedAt    DateTime?      @map("converted_at")

  @@map("referrals")
}

// ─────────────────────────────────────
// 23.41 SEO_Templates
// ─────────────────────────────────────
model SeoTemplate {
  id                  Int      @id @default(autoincrement())
  entityType          String   @map("entity_type")
  scope               String
  categoryId          Int?     @map("category_id")
  titleTemplate       String   @map("title_template")
  descriptionTemplate String   @map("description_template")
  altTemplate         String?  @map("alt_template")
  isActive            Boolean  @default(true) @map("is_active")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  @@unique([entityType, scope, categoryId])
  @@map("seo_templates")
}

// ─────────────────────────────────────
// 23.43 Subscribers
// ─────────────────────────────────────
enum SubscriberStatus {
  pending_sub  @map("pending")
  confirmed
  unsubscribed
}

model Subscriber {
  id                Int              @id @default(autoincrement())
  email             String           @unique
  status            SubscriberStatus @default(pending_sub)
  confirmationToken String?          @map("confirmation_token")
  confirmedAt       DateTime?        @map("confirmed_at")
  unsubscribedAt    DateTime?        @map("unsubscribed_at")
  source            String?
  createdAt         DateTime         @default(now()) @map("created_at")

  @@map("subscribers")
}

// ─────────────────────────────────────
// 23.44-45 Analytics
// ─────────────────────────────────────
model ClientEvent {
  id        Int      @id @default(autoincrement())
  eventType String   @map("event_type")
  userId    Int?     @map("user_id")
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  sessionId String?  @map("session_id")
  productId Int?     @map("product_id")
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  orderId   Int?     @map("order_id")
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  @@index([eventType, createdAt])
  @@index([userId, createdAt])
  @@index([sessionId])
  @@map("client_events")
}

model DailyFunnelStats {
  id              Int      @id @default(autoincrement())
  date            DateTime @db.Date
  deviceType      String?  @map("device_type")
  trafficSource   String?  @map("traffic_source")
  pageViews       Int      @default(0) @map("page_views")
  productViews    Int      @default(0) @map("product_views")
  addToCartCount  Int      @default(0) @map("add_to_cart_count")
  cartViews       Int      @default(0) @map("cart_views")
  checkoutStarts  Int      @default(0) @map("checkout_starts")
  ordersCompleted Int      @default(0) @map("orders_completed")
  totalRevenue    Decimal  @default(0) @map("total_revenue") @db.Decimal(12, 2)
  uniqueVisitors  Int      @default(0) @map("unique_visitors")

  @@index([date])
  @@index([date, deviceType])
  @@map("daily_funnel_stats")
}

// ─────────────────────────────────────
// 23.48 Import_Log
// ─────────────────────────────────────
enum ImportStatus {
  pending_import    @map("pending")
  processing_import @map("processing")
  completed_import  @map("completed")
  failed_import     @map("failed")
}

model ImportLog {
  id            Int          @id @default(autoincrement())
  managerId     Int          @map("manager_id")
  manager       User         @relation(fields: [managerId], references: [id])
  filename      String
  fileSizeBytes Int?         @map("file_size_bytes")
  status        ImportStatus @default(pending_import)
  totalRows     Int          @default(0) @map("total_rows")
  createdCount  Int          @default(0) @map("created_count")
  updatedCount  Int          @default(0) @map("updated_count")
  skippedCount  Int          @default(0) @map("skipped_count")
  errorCount    Int          @default(0) @map("error_count")
  errorsJson    Json?        @map("errors_json")
  startedAt     DateTime?    @map("started_at")
  completedAt   DateTime?    @map("completed_at")
  durationMs    Int?         @map("duration_ms")

  @@index([managerId])
  @@index([status])
  @@map("import_log")
}

// ─────────────────────────────────────
// 23.50 Notification_Queue
// ─────────────────────────────────────
enum NotificationChannel {
  email
  telegram
  viber
  instagram
  push
}

enum QueueStatus {
  pending_queue    @map("pending")
  processing_queue @map("processing")
  sent
  failed_queue     @map("failed")
}

model NotificationQueue {
  id           Int                 @id @default(autoincrement())
  channel      NotificationChannel
  recipient    String
  subject      String?
  bodyTemplate String              @map("body_template")
  bodyParams   Json?               @map("body_params")
  status       QueueStatus         @default(pending_queue)
  attempts     Int                 @default(0)
  maxAttempts  Int                 @default(3) @map("max_attempts")
  errorMessage String?             @map("error_message")
  scheduledAt  DateTime?           @map("scheduled_at")
  sentAt       DateTime?           @map("sent_at")
  createdAt    DateTime            @default(now()) @map("created_at")

  @@index([status, scheduledAt])
  @@index([channel, status])
  @@map("notification_queue")
}

// ─────────────────────────────────────
// 23.19-27 Messenger & Dashboard tables
// ─────────────────────────────────────
model DashboardSettings {
  id                     Int      @id @default(autoincrement())
  userId                 Int      @unique @map("user_id")
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  layout                 Json?
  lowStockThreshold      Int      @default(10) @map("low_stock_threshold")
  refreshIntervalSeconds Int      @default(60) @map("refresh_interval_seconds")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  @@map("dashboard_settings")
}

model ReportTemplate {
  id            Int      @id @default(autoincrement())
  name          String
  createdBy     Int      @map("created_by")
  creator       User     @relation(fields: [createdBy], references: [id])
  reportType    String   @map("report_type")
  filters       Json?
  metrics       Json?
  schedule      String?
  scheduleEmail String?  @map("schedule_email")
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("report_templates")
}

model AnalyticsAlert {
  id                   Int       @id @default(autoincrement())
  createdBy            Int       @map("created_by")
  creator              User      @relation(fields: [createdBy], references: [id])
  alertType            String    @map("alert_type")
  condition            Json
  notificationChannels String    @map("notification_channels")
  isActive             Boolean   @default(true) @map("is_active")
  lastTriggeredAt      DateTime? @map("last_triggered_at")
  createdAt            DateTime  @default(now()) @map("created_at")

  @@map("analytics_alerts")
}

model ChannelVisit {
  id               Int      @id @default(autoincrement())
  source           String
  utmCampaign      String?  @map("utm_campaign")
  utmMedium        String?  @map("utm_medium")
  utmSource        String?  @map("utm_source")
  landingPage      String?  @map("landing_page")
  userId           Int?     @map("user_id")
  sessionId        String?  @map("session_id")
  convertedToOrder Boolean  @default(false) @map("converted_to_order")
  orderId          Int?     @map("order_id")
  createdAt        DateTime @default(now()) @map("created_at")

  @@map("channel_visits")
}

model BotAutoReply {
  id            Int      @id @default(autoincrement())
  platform      String
  triggerType   String   @map("trigger_type")
  triggerText   String?  @map("trigger_text")
  responseText  String   @map("response_text")
  responseImage String?  @map("response_image")
  buttons       Json?
  priority      Int      @default(0)
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("bot_auto_replies")
}

model BotWelcomeMessage {
  id           Int      @id @default(autoincrement())
  platform     String
  variant      String   @default("A")
  messageText  String   @map("message_text")
  messageImage String?  @map("message_image")
  buttons      Json?
  promoCode    String?  @map("promo_code")
  promoLink    String?  @map("promo_link")
  impressions  Int      @default(0)
  conversions  Int      @default(0)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("bot_welcome_messages")
}

model ModerationRule {
  id        Int             @id @default(autoincrement())
  platform  String
  ruleType  String          @map("rule_type")
  config    Json
  action    String
  isActive  Boolean         @default(true) @map("is_active")
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")
  logs      ModerationLog[]

  @@map("moderation_rules")
}

model ModerationLog {
  id              Int             @id @default(autoincrement())
  platform        String
  userPlatformId  String          @map("user_platform_id")
  userName        String?         @map("user_name")
  ruleId          Int?            @map("rule_id")
  rule            ModerationRule? @relation(fields: [ruleId], references: [id])
  originalMessage String?         @map("original_message")
  actionTaken     String          @map("action_taken")
  isFalsePositive Boolean         @default(false) @map("is_false_positive")
  createdAt       DateTime        @default(now()) @map("created_at")

  @@map("moderation_log")
}

// ─────────────────────────────────────
// Loyalty Program
// ─────────────────────────────────────
model LoyaltyAccount {
  id         Int      @id @default(autoincrement())
  userId     Int      @unique @map("user_id")
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  points     Int      @default(0)
  totalSpent Decimal  @default(0) @map("total_spent") @db.Decimal(12, 2)
  level      String   @default("bronze")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  @@map("loyalty_accounts")
}

model LoyaltyTransaction {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        String   // 'earn' | 'spend' | 'manual_add' | 'manual_deduct' | 'expire'
  points      Int
  orderId     Int?     @map("order_id")
  description String
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@map("loyalty_transactions")
}

model LoyaltyLevel {
  id               Int     @id @default(autoincrement())
  name             String  @unique
  minSpent         Decimal @map("min_spent") @db.Decimal(12, 2)
  pointsMultiplier Float   @default(1.0) @map("points_multiplier")
  discountPercent  Decimal @default(0) @map("discount_percent") @db.Decimal(5, 2)
  benefits         Json?
  sortOrder        Int     @default(0) @map("sort_order")

  @@map("loyalty_levels")
}

// ─────────────────────────────────────
// Performance Metrics (Web Vitals)
// ─────────────────────────────────────
model PerformanceMetric {
  id          Int      @id @default(autoincrement())
  date        DateTime @db.Date
  route       String
  metric      String   // 'LCP', 'CLS', 'FID', 'TTFB', 'INP'
  p50         Float
  p75         Float
  p90         Float
  sampleCount Int      @default(0) @map("sample_count")
  createdAt   DateTime @default(now()) @map("created_at")

  @@unique([date, route, metric])
  @@map("performance_metrics")
}

// ─────────────────────────────────────
// Push Subscriptions (PWA)
// ─────────────────────────────────────
model PushSubscription {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@map("push_subscriptions")
}

model ChannelStats {
  id               Int      @id @default(autoincrement())
  platform         String
  channelType      String   @map("channel_type")
  subscribersCount Int      @default(0) @map("subscribers_count")
  newSubscribers   Int      @default(0) @map("new_subscribers")
  unsubscribes     Int      @default(0)
  messagesCount    Int      @default(0) @map("messages_count")
  reach            Int?
  engagementRate   Decimal? @map("engagement_rate") @db.Decimal(5, 2)
  recordedAt       DateTime @default(now()) @map("recorded_at")

  @@map("channel_stats")
}

// ─────────────────────────────────────
// Slug Redirects (SEO 301 redirects for changed slugs)
// ─────────────────────────────────────
model SlugRedirect {
  id        Int      @id @default(autoincrement())
  oldSlug   String   @unique @map("old_slug")
  newSlug   String   @map("new_slug")
  type      String   @default("product")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("slug_redirects")
}
